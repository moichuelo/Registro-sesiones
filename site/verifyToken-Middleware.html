
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentación del proyecto Registro (DeepWiki dump)">
      
      
      
      
        <link rel="prev" href="JWT-Token-Management.html">
      
      
        <link rel="next" href="Security-Measures.html">
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>verifyToken Middleware - DeepWiki — Registro</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#verifytoken-middleware" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="DeepWiki — Registro" class="md-header__button md-logo" aria-label="DeepWiki — Registro" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DeepWiki — Registro
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              verifyToken Middleware
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="cyan"  aria-label="Modo oscuro"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Modo oscuro" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="cyan"  aria-label="Modo claro"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Modo claro" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="DeepWiki — Registro" class="md-nav__button md-logo" aria-label="DeepWiki — Registro" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    DeepWiki — Registro
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Overview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Getting-Started.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture Overview
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Architecture Overview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Architecture-Overview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="System-Components.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    System Components
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Technology-Stack.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Technology Stack
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Request-Processing-Pipeline.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Request Processing Pipeline
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Application-Bootstrap.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Application Bootstrap
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Routing System
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Routing System
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Routing-System.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Routing System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Public-Routes.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Public Routes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Protected-Routes.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Protected Routes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="API-Endpoints.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Endpoints
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Authentication & Authorization
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Authentication & Authorization
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Authentication-%26-Authorization.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Authentication & Authorization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="User-Registration-%26-Login.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    User Registration & Login
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="JWT-Token-Management.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    JWT Token Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    verifyToken Middleware
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="verifyToken-Middleware.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    verifyToken Middleware
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#purpose-and-scope" class="md-nav__link">
    <span class="md-ellipsis">
      Purpose and Scope
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#middleware-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Middleware Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Middleware Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-function-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Core Function Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-extraction" class="md-nav__link">
    <span class="md-ellipsis">
      Token Extraction
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#token-verification-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Token Verification Flow
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Token Verification Flow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jwt-payload-structure" class="md-nav__link">
    <span class="md-ellipsis">
      JWT Payload Structure
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-with-routes" class="md-nav__link">
    <span class="md-ellipsis">
      Integration with Routes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Integration with Routes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protected-routes-summary" class="md-nav__link">
    <span class="md-ellipsis">
      Protected Routes Summary
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#request-processing-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Request Processing Pipeline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#401-unauthorized-missing-token" class="md-nav__link">
    <span class="md-ellipsis">
      401 Unauthorized - Missing Token
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#403-forbidden-invalid-token" class="md-nav__link">
    <span class="md-ellipsis">
      403 Forbidden - Invalid Token
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-response-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Error Response Flow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Security Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Security Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#http-only-cookies" class="md-nav__link">
    <span class="md-ellipsis">
      HTTP-Only Cookies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secret-key-verification" class="md-nav__link">
    <span class="md-ellipsis">
      Secret Key Verification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-expiration" class="md-nav__link">
    <span class="md-ellipsis">
      Token Expiration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#synchronous-verification" class="md-nav__link">
    <span class="md-ellipsis">
      Synchronous Verification
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage-in-route-definitions" class="md-nav__link">
    <span class="md-ellipsis">
      Usage in Route Definitions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Usage in Route Definitions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-middleware-application" class="md-nav__link">
    <span class="md-ellipsis">
      Single Middleware Application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chained-middleware-application" class="md-nav__link">
    <span class="md-ellipsis">
      Chained Middleware Application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-user-information" class="md-nav__link">
    <span class="md-ellipsis">
      Accessing User Information
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#relationship-with-authentication-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Relationship with Authentication Flow
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Security-Measures.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security Measures
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Real-time Communication System
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Real-time Communication System
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Real-time-Communication-System.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Real-time Communication System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Socket.IO-Server-Setup.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Socket.IO Server Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="WebSocket-Authentication.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WebSocket Authentication
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Room-Management.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Room Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Message-Handling.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Message Handling
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Product-Management.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Product Management
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Support Chat System
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Support Chat System
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Support-Chat-System.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Support Chat System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="User-Chat-Interface.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    User Chat Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Admin-Chat-Interface.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Admin Chat Interface
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    PDF Generation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            PDF Generation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="PDF-Generation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PDF Generation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Puppeteer-PDF-Generation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Puppeteer PDF Generation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="PDFKit-PDF-Generation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PDFKit PDF Generation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Internationalization-%28i18n%29.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Internationalization (i18n)
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    View Layer & Templates
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            View Layer & Templates
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Template-Structure.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Template Structure
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Partial-Components.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Partial Components
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Page-Views.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Page Views
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Static-Assets-%26-Styling.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Static Assets & Styling
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
        
          
          <label class="md-nav__link" for="__nav_15" id="__nav_15_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Database Schema
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_15">
            <span class="md-nav__icon md-icon"></span>
            Database Schema
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Database-Schema.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Database Schema
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="usuarios-Table.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    usuarios Table
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="productos-Table.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    productos Table
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mensajes-Table.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    mensajes Table
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_16" >
        
          
          <label class="md-nav__link" for="__nav_16" id="__nav_16_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_16_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_16">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="API-Reference.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="HTTP-Endpoints.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HTTP Endpoints
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="WebSocket-Events.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WebSocket Events
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Deployment-%26-Configuration.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deployment & Configuration
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    README
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#purpose-and-scope" class="md-nav__link">
    <span class="md-ellipsis">
      Purpose and Scope
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#middleware-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Middleware Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Middleware Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-function-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Core Function Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-extraction" class="md-nav__link">
    <span class="md-ellipsis">
      Token Extraction
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#token-verification-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Token Verification Flow
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Token Verification Flow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jwt-payload-structure" class="md-nav__link">
    <span class="md-ellipsis">
      JWT Payload Structure
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-with-routes" class="md-nav__link">
    <span class="md-ellipsis">
      Integration with Routes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Integration with Routes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protected-routes-summary" class="md-nav__link">
    <span class="md-ellipsis">
      Protected Routes Summary
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#request-processing-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Request Processing Pipeline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#401-unauthorized-missing-token" class="md-nav__link">
    <span class="md-ellipsis">
      401 Unauthorized - Missing Token
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#403-forbidden-invalid-token" class="md-nav__link">
    <span class="md-ellipsis">
      403 Forbidden - Invalid Token
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-response-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Error Response Flow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Security Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Security Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#http-only-cookies" class="md-nav__link">
    <span class="md-ellipsis">
      HTTP-Only Cookies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secret-key-verification" class="md-nav__link">
    <span class="md-ellipsis">
      Secret Key Verification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-expiration" class="md-nav__link">
    <span class="md-ellipsis">
      Token Expiration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#synchronous-verification" class="md-nav__link">
    <span class="md-ellipsis">
      Synchronous Verification
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage-in-route-definitions" class="md-nav__link">
    <span class="md-ellipsis">
      Usage in Route Definitions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Usage in Route Definitions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-middleware-application" class="md-nav__link">
    <span class="md-ellipsis">
      Single Middleware Application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chained-middleware-application" class="md-nav__link">
    <span class="md-ellipsis">
      Chained Middleware Application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-user-information" class="md-nav__link">
    <span class="md-ellipsis">
      Accessing User Information
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#relationship-with-authentication-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Relationship with Authentication Flow
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="verifytoken-middleware">verifyToken Middleware<a class="headerlink" href="#verifytoken-middleware" title="Permanent link">&para;</a></h1>
<blockquote>
<p><strong>Relevant source files</strong>
* <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/middlewares/verifyToken.js">src/middlewares/verifyToken.js</a>
* <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js">src/router.js</a></p>
</blockquote>
<h2 id="purpose-and-scope">Purpose and Scope<a class="headerlink" href="#purpose-and-scope" title="Permanent link">&para;</a></h2>
<p>The <code>verifyToken</code> middleware is a critical authentication component that validates JSON Web Tokens (JWT) from HTTP cookies and attaches authenticated user information to incoming requests. This middleware serves as the primary gatekeeper for protected routes, ensuring that only authenticated users can access specific endpoints.</p>
<p>This page documents the middleware implementation, verification flow, integration with the routing system, and error handling. For information about JWT token generation and storage during login, see <a href="JWT-Token-Management.html">JWT Token Management</a>. For role-based authorization that builds on top of token verification, see <a href="verifyAdmin-Middleware.html">verifyAdmin Middleware</a>.</p>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/middlewares/verifyToken.js#L1-L17">src/middlewares/verifyToken.js L1-L17</a></p>
<hr />
<h2 id="middleware-implementation">Middleware Implementation<a class="headerlink" href="#middleware-implementation" title="Permanent link">&para;</a></h2>
<p>The <code>verifyToken</code> middleware is implemented in a single, focused function that performs JWT validation. The complete implementation is located at <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/middlewares/verifyToken.js#L1-L17">src/middlewares/verifyToken.js L1-L17</a></p>
<h3 id="core-function-structure">Core Function Structure<a class="headerlink" href="#core-function-structure" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>verifyToken(req, res, next)
</code></pre></div>
<p>The middleware follows the standard Express middleware signature, accepting the request object, response object, and next function.</p>
<table>
<thead>
<tr>
<th>Step</th>
<th>Action</th>
<th>Code Reference</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Extract token from cookies</td>
<td><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/middlewares/verifyToken.js#L4-L4">src/middlewares/verifyToken.js L4</a></td>
</tr>
<tr>
<td>2</td>
<td>Check token existence</td>
<td><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/middlewares/verifyToken.js#L6-L6">src/middlewares/verifyToken.js L6</a></td>
</tr>
<tr>
<td>3</td>
<td>Verify token with JWT secret</td>
<td><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/middlewares/verifyToken.js#L9-L9">src/middlewares/verifyToken.js L9</a></td>
</tr>
<tr>
<td>4</td>
<td>Attach payload to request</td>
<td><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/middlewares/verifyToken.js#L10-L10">src/middlewares/verifyToken.js L10</a></td>
</tr>
<tr>
<td>5</td>
<td>Pass control to next middleware</td>
<td><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/middlewares/verifyToken.js#L11-L11">src/middlewares/verifyToken.js L11</a></td>
</tr>
</tbody>
</table>
<h3 id="token-extraction">Token Extraction<a class="headerlink" href="#token-extraction" title="Permanent link">&para;</a></h3>
<p>The middleware extracts the JWT token from the <code>token</code> cookie using the <code>cookie-parser</code> middleware that runs earlier in the request pipeline:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">token</span><span class="p">;</span>
</code></pre></div>
<p>This assumes that <code>cookie-parser</code> has already processed the request and populated <code>req.cookies</code>. The token itself was set during the login process at <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L570-L574">src/router.js L570-L574</a></p>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/middlewares/verifyToken.js#L3-L6">src/middlewares/verifyToken.js L3-L6</a></p>
<hr />
<h2 id="token-verification-flow">Token Verification Flow<a class="headerlink" href="#token-verification-flow" title="Permanent link">&para;</a></h2>
<p>The following diagram illustrates the complete verification flow when a request encounters the <code>verifyToken</code> middleware:</p>
<pre class="mermaid"><code>flowchart TD

Request["Incoming Request"]
ExtractToken["Extract token from req.cookies.token"]
CheckExists["Token exists?"]
VerifyToken["jwt.verify(token, JWT_SECRET)"]
VerifySuccess["Verification&lt;br&gt;successful?"]
AttachPayload["req.user = payload"]
CallNext["next()"]
Return401["return res.status(401)&lt;br&gt;.send('No autenticado')"]
Return403["return res.status(403)&lt;br&gt;.send('Token inválido')"]
RouteHandler["Route Handler Executes"]
End["Response Sent"]

Request --&gt; ExtractToken
ExtractToken --&gt; CheckExists
CheckExists --&gt; Return401
CheckExists --&gt; VerifyToken
VerifyToken --&gt; VerifySuccess
VerifySuccess --&gt; AttachPayload
VerifySuccess --&gt; Return403
AttachPayload --&gt; CallNext
CallNext --&gt; RouteHandler
Return401 --&gt; End
Return403 --&gt; End</code></pre>
<p><strong>Token Verification Process:</strong></p>
<h3 id="jwt-payload-structure">JWT Payload Structure<a class="headerlink" href="#jwt-payload-structure" title="Permanent link">&para;</a></h3>
<p>Upon successful verification, the middleware attaches the decoded JWT payload to <code>req.user</code>. The payload structure matches what was created during login at <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L559-L564">src/router.js L559-L564</a></p>
<p>:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>user</code></td>
<td>Username from <code>usuarios.usuario</code></td>
<td><code>"john_doe"</code></td>
</tr>
<tr>
<td><code>name</code></td>
<td>Display name from <code>usuarios.nombre</code></td>
<td><code>"John Doe"</code></td>
</tr>
<tr>
<td><code>rol</code></td>
<td>User role from <code>usuarios.rol</code></td>
<td><code>"admin"</code> or <code>"user"</code></td>
</tr>
<tr>
<td><code>imagen</code></td>
<td>Profile image filename</td>
<td><code>"profile_123.jpg"</code> or <code>null</code></td>
</tr>
</tbody>
</table>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/middlewares/verifyToken.js#L8-L14">src/middlewares/verifyToken.js L8-L14</a></p>
<p><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L559-L564">src/router.js L559-L564</a></p>
<hr />
<h2 id="integration-with-routes">Integration with Routes<a class="headerlink" href="#integration-with-routes" title="Permanent link">&para;</a></h2>
<p>The <code>verifyToken</code> middleware is imported into the router module and applied to protected routes requiring authentication. The following diagram shows the relationship between the middleware, routes, and route handlers:</p>
<pre class="mermaid"><code>flowchart TD

Import["require('./middlewares/verifyToken')"]
AdminRoute["GET /admin"]
PdfAdminRoute["GET /pdfAdmin"]
SoporteRoute["GET /soporte"]
MensajesMiosRoute["GET /api/mensajes/mios"]
PdfDescargarRoute["GET /pdf/descargar"]
PdfkitDescargarRoute["GET /pdfkit/descargar"]
AdminHandler["Render admin view&lt;br&gt;with productos"]
PdfAdminHandler["Render pdfTabla view"]
SoporteHandler["Render soporte view"]
MensajesHandler["Query mensajes table"]
PdfHandler["Generate PDF&lt;br&gt;with Puppeteer"]
PdfkitHandler["Generate PDF&lt;br&gt;with PDFKit"]
VerifyToken["verifyToken middleware"]
IncomingRequest["HTTP Request"]

Import --&gt; VerifyToken
IncomingRequest --&gt; AdminRoute
IncomingRequest --&gt; PdfAdminRoute
IncomingRequest --&gt; SoporteRoute
IncomingRequest --&gt; MensajesMiosRoute
IncomingRequest --&gt; PdfDescargarRoute
IncomingRequest --&gt; PdfkitDescargarRoute
AdminRoute --&gt; VerifyToken
PdfAdminRoute --&gt; VerifyToken
SoporteRoute --&gt; VerifyToken
MensajesMiosRoute --&gt; VerifyToken
PdfDescargarRoute --&gt; VerifyToken
PdfkitDescargarRoute --&gt; VerifyToken
VerifyToken --&gt; AdminHandler
VerifyToken --&gt; PdfAdminHandler
VerifyToken --&gt; SoporteHandler
VerifyToken --&gt; MensajesHandler
VerifyToken --&gt; PdfHandler
VerifyToken --&gt; PdfkitHandler

subgraph subGraph4 ["Request Flow"]
    IncomingRequest
end

subgraph src/middlewares/verifyToken.js ["src/middlewares/verifyToken.js"]
    VerifyToken
end

subgraph src/router.js ["src/router.js"]
    Import

subgraph subGraph1 ["Route Handlers"]
    AdminHandler
    PdfAdminHandler
    SoporteHandler
    MensajesHandler
    PdfHandler
    PdfkitHandler
end

subgraph subGraph0 ["Protected Routes"]
    AdminRoute
    PdfAdminRoute
    SoporteRoute
    MensajesMiosRoute
    PdfDescargarRoute
    PdfkitDescargarRoute
end
end</code></pre>
<h3 id="protected-routes-summary">Protected Routes Summary<a class="headerlink" href="#protected-routes-summary" title="Permanent link">&para;</a></h3>
<p>The following table lists all routes protected by <code>verifyToken</code>:</p>
<table>
<thead>
<tr>
<th>Route</th>
<th>HTTP Method</th>
<th>Purpose</th>
<th>Line Reference</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/admin</code></td>
<td>GET</td>
<td>Admin dashboard with product list</td>
<td><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L119-L119">src/router.js L119</a></td>
</tr>
<tr>
<td><code>/pdfAdmin</code></td>
<td>GET</td>
<td>PDF preview of products</td>
<td><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L136-L136">src/router.js L136</a></td>
</tr>
<tr>
<td><code>/soporte</code></td>
<td>GET</td>
<td>Support chat interface</td>
<td><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L220-L220">src/router.js L220</a></td>
</tr>
<tr>
<td><code>/api/mensajes/mios</code></td>
<td>GET</td>
<td>Retrieve user's own messages</td>
<td><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L256-L256">src/router.js L256</a></td>
</tr>
<tr>
<td><code>/pdf/descargar</code></td>
<td>GET</td>
<td>Generate and download PDF (Puppeteer)</td>
<td><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L317-L317">src/router.js L317</a></td>
</tr>
<tr>
<td><code>/pdfkit/descargar</code></td>
<td>GET</td>
<td>Generate and download PDF (PDFKit)</td>
<td><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L355-L355">src/router.js L355</a></td>
</tr>
</tbody>
</table>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L16-L16">src/router.js L16</a></p>
<p><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L119-L119">src/router.js L119</a></p>
<p><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L136-L136">src/router.js L136</a></p>
<p><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L220-L220">src/router.js L220</a></p>
<p><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L256-L256">src/router.js L256</a></p>
<p><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L317-L317">src/router.js L317</a></p>
<p><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L355-L355">src/router.js L355</a></p>
<hr />
<h2 id="request-processing-pipeline">Request Processing Pipeline<a class="headerlink" href="#request-processing-pipeline" title="Permanent link">&para;</a></h2>
<p>The following diagram illustrates how <code>verifyToken</code> fits into the complete request processing pipeline, showing the middleware stack and the order of execution:</p>
<pre class="mermaid"><code>sequenceDiagram
  participant Client
  participant Express
  participant cookie-parser
  participant verifyToken
  participant Route Handler
  participant MySQL DB

  Client-&gt;&gt;Express: GET /admin with Cookie: token=xyz
  Express-&gt;&gt;cookie-parser: Process request
  cookie-parser-&gt;&gt;cookie-parser: Parse cookies into req.cookies
  cookie-parser-&gt;&gt;verifyToken: next()
  verifyToken-&gt;&gt;verifyToken: Extract req.cookies.token
  loop [Verification fails]
    verifyToken--&gt;&gt;Client: 401 No autenticado
    verifyToken-&gt;&gt;verifyToken: jwt.verify(token, JWT_SECRET)
    verifyToken--&gt;&gt;Client: 403 Token inválido
    verifyToken-&gt;&gt;verifyToken: req.user = payload
    verifyToken-&gt;&gt;Route Handler: next()
    Route Handler-&gt;&gt;MySQL DB: Query data
    MySQL DB--&gt;&gt;Route Handler: Results
    Route Handler--&gt;&gt;Client: 200 Response with data
  end</code></pre>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/middlewares/verifyToken.js#L3-L14">src/middlewares/verifyToken.js L3-L14</a></p>
<p><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L119-L134">src/router.js L119-L134</a></p>
<hr />
<h2 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h2>
<p>The <code>verifyToken</code> middleware implements two distinct error conditions with different HTTP status codes:</p>
<h3 id="401-unauthorized-missing-token">401 Unauthorized - Missing Token<a class="headerlink" href="#401-unauthorized-missing-token" title="Permanent link">&para;</a></h3>
<p>Returned when the <code>token</code> cookie is not present in the request. This occurs when:</p>
<ul>
<li>User has not logged in</li>
<li>Token cookie has expired</li>
<li>Cookie was manually deleted</li>
<li>Request is made without cookies</li>
</ul>
<p><strong>Implementation:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/middlewares/verifyToken.js#L6-L6">src/middlewares/verifyToken.js L6</a></p>
<div class="highlight"><pre><span></span><code>if (!token) return res.status(401).send(&quot;No autenticado&quot;);
</code></pre></div>
<h3 id="403-forbidden-invalid-token">403 Forbidden - Invalid Token<a class="headerlink" href="#403-forbidden-invalid-token" title="Permanent link">&para;</a></h3>
<p>Returned when JWT verification fails inside the try-catch block. This occurs when:</p>
<ul>
<li>Token has been tampered with</li>
<li>Token signature is invalid</li>
<li>Token has expired (JWT expiration is 1 hour from <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L567-L567">src/router.js L567</a> )</li>
<li>Token was signed with a different secret</li>
</ul>
<p><strong>Implementation:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/middlewares/verifyToken.js#L12-L13">src/middlewares/verifyToken.js L12-L13</a></p>
<div class="highlight"><pre><span></span><code>catch (err) {
    return res.status(403).send(&quot;Token inválido&quot;);
}
</code></pre></div>
<h3 id="error-response-flow">Error Response Flow<a class="headerlink" href="#error-response-flow" title="Permanent link">&para;</a></h3>
<pre class="mermaid"><code>flowchart TD

Request["Request with&lt;br&gt;Cookie Header"]
NoCookie["No token cookie"]
InvalidSignature["Invalid signature"]
Expired["Token expired"]
Tampered["Token tampered"]
Res401["HTTP 401&lt;br&gt;No autenticado"]
Res403["HTTP 403&lt;br&gt;Token inválido"]

Request --&gt; NoCookie
Request --&gt; InvalidSignature
Request --&gt; Expired
Request --&gt; Tampered
NoCookie --&gt; Res401
InvalidSignature --&gt; Res403
Expired --&gt; Res403
Tampered --&gt; Res403

subgraph subGraph1 ["HTTP Responses"]
    Res401
    Res403
end

subgraph subGraph0 ["Error Cases"]
    NoCookie
    InvalidSignature
    Expired
    Tampered
end</code></pre>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/middlewares/verifyToken.js#L6-L14">src/middlewares/verifyToken.js L6-L14</a></p>
<hr />
<h2 id="security-considerations">Security Considerations<a class="headerlink" href="#security-considerations" title="Permanent link">&para;</a></h2>
<p>The <code>verifyToken</code> middleware implements several security best practices:</p>
<h3 id="http-only-cookies">HTTP-Only Cookies<a class="headerlink" href="#http-only-cookies" title="Permanent link">&para;</a></h3>
<p>The JWT token is stored in an HTTP-only cookie (set at <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L570-L574">src/router.js L570-L574</a></p>
<p>), which prevents JavaScript access to the token, mitigating XSS attacks. The middleware reads from <code>req.cookies.token</code>, which is only accessible server-side.</p>
<h3 id="secret-key-verification">Secret Key Verification<a class="headerlink" href="#secret-key-verification" title="Permanent link">&para;</a></h3>
<p>The middleware uses <code>process.env.JWT_SECRET</code> to verify token signatures. This secret is:</p>
<ul>
<li>Stored in environment variables (not in code)</li>
<li>Used for both signing (during login) and verification</li>
<li>Required for the <code>jwt.verify()</code> call to succeed</li>
</ul>
<h3 id="token-expiration">Token Expiration<a class="headerlink" href="#token-expiration" title="Permanent link">&para;</a></h3>
<p>While the middleware itself doesn't check expiration explicitly, the <code>jwt.verify()</code> function automatically validates the <code>exp</code> claim in the token. Tokens are created with a 1-hour expiration at <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L567-L567">src/router.js L567</a></p>
<h3 id="synchronous-verification">Synchronous Verification<a class="headerlink" href="#synchronous-verification" title="Permanent link">&para;</a></h3>
<p>The <code>jwt.verify()</code> call at <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/middlewares/verifyToken.js#L9-L9">src/middlewares/verifyToken.js L9</a></p>
<p>is synchronous, which is appropriate for the verification use case and prevents timing attacks that could occur with asynchronous operations.</p>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/middlewares/verifyToken.js#L9-L9">src/middlewares/verifyToken.js L9</a></p>
<p><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L567-L567">src/router.js L567</a></p>
<p><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L570-L574">src/router.js L570-L574</a></p>
<hr />
<h2 id="usage-in-route-definitions">Usage in Route Definitions<a class="headerlink" href="#usage-in-route-definitions" title="Permanent link">&para;</a></h2>
<p>The middleware is applied to routes using Express's standard middleware pattern. Here are concrete examples from the codebase:</p>
<h3 id="single-middleware-application">Single Middleware Application<a class="headerlink" href="#single-middleware-application" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/admin&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">verifyToken</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// req.user is now available</span>
<span class="w">    </span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM productos&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="nx">results</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">productos</span><span class="o">:</span><span class="w"> </span><span class="nx">results</span><span class="p">,</span>
<span class="w">            </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span><span class="w">  </span><span class="c1">// Access authenticated user</span>
<span class="w">            </span><span class="nx">login</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="nx">rol</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">rol</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p><strong>Location:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L119-L134">src/router.js L119-L134</a></p>
<h3 id="chained-middleware-application">Chained Middleware Application<a class="headerlink" href="#chained-middleware-application" title="Permanent link">&para;</a></h3>
<p>For admin-only routes, <code>verifyToken</code> is chained with <code>verifyAdmin</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/api/mensajes&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">verifyAdmin</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// verifyAdmin internally ensures verifyToken runs first</span>
<span class="w">    </span><span class="c1">// Both req.user and admin role are validated</span>
<span class="p">});</span>
</code></pre></div>
<p><strong>Location:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L229-L229">src/router.js L229</a></p>
<h3 id="accessing-user-information">Accessing User Information<a class="headerlink" href="#accessing-user-information" title="Permanent link">&para;</a></h3>
<p>After successful verification, route handlers access the authenticated user through <code>req.user</code>:</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Access Pattern</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Username</td>
<td><code>req.user.user</code></td>
<td>Used at <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L223-L223">src/router.js L223</a></td>
</tr>
<tr>
<td>Display Name</td>
<td><code>req.user.name</code></td>
<td>Used at <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L65-L65">src/router.js L65</a></td>
</tr>
<tr>
<td>Role</td>
<td><code>req.user.rol</code></td>
<td>Used at <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L130-L130">src/router.js L130</a></td>
</tr>
<tr>
<td>Profile Image</td>
<td><code>req.user.imagen</code></td>
<td>Included in payload</td>
</tr>
</tbody>
</table>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L119-L134">src/router.js L119-L134</a></p>
<p><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L220-L227">src/router.js L220-L227</a></p>
<p><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L229-L229">src/router.js L229</a></p>
<p><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L256-L280">src/router.js L256-L280</a></p>
<hr />
<h2 id="relationship-with-authentication-flow">Relationship with Authentication Flow<a class="headerlink" href="#relationship-with-authentication-flow" title="Permanent link">&para;</a></h2>
<p>The <code>verifyToken</code> middleware is the validation counterpart to the token generation that occurs during login:</p>
<pre class="mermaid"><code>flowchart TD

LoginForm["POST /auth"]
ValidateCredentials["Validate credentials&lt;br&gt;bcrypt.compare()"]
CreatePayload["Create JWT payload&lt;br&gt;{user, name, rol, imagen}"]
SignToken["jwt.sign()&lt;br&gt;with JWT_SECRET&lt;br&gt;expiresIn: 1h"]
SetCookie["res.cookie('token')&lt;br&gt;httpOnly: true"]
ProtectedRoute["GET /admin"]
VerifyTokenMW["verifyToken middleware"]
ExtractCookie["Extract req.cookies.token"]
VerifyJWT["jwt.verify()&lt;br&gt;with JWT_SECRET"]
AttachUser["req.user = payload"]
RouteHandler["Route handler&lt;br&gt;accesses req.user"]

SetCookie --&gt; ProtectedRoute

subgraph subGraph1 ["Protected Route - Token Verification"]
    ProtectedRoute
    VerifyTokenMW
    ExtractCookie
    VerifyJWT
    AttachUser
    RouteHandler
    ProtectedRoute --&gt; VerifyTokenMW
    VerifyTokenMW --&gt; ExtractCookie
    ExtractCookie --&gt; VerifyJWT
    VerifyJWT --&gt; AttachUser
    AttachUser --&gt; RouteHandler
end

subgraph subGraph0 ["Login Flow - Token Generation"]
    LoginForm
    ValidateCredentials
    CreatePayload
    SignToken
    SetCookie
    LoginForm --&gt; ValidateCredentials
    ValidateCredentials --&gt; CreatePayload
    CreatePayload --&gt; SignToken
    SignToken --&gt; SetCookie
end</code></pre>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L532-L601">src/router.js L532-L601</a></p>
<p><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/middlewares/verifyToken.js#L1-L17">src/middlewares/verifyToken.js L1-L17</a></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": ".", "features": ["content.code.copy"], "search": "assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
      
        <script src="javascripts/mermaid-init.js"></script>
      
    
  </body>
</html>