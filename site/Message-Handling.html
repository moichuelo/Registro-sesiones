
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentación del proyecto Registro (DeepWiki dump)">
      
      
      
      
        <link rel="prev" href="Room-Management.html">
      
      
        <link rel="next" href="Product-Management.html">
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>Message Handling - DeepWiki — Registro</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#message-handling" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="DeepWiki — Registro" class="md-header__button md-logo" aria-label="DeepWiki — Registro" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DeepWiki — Registro
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Message Handling
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="cyan"  aria-label="Modo oscuro"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Modo oscuro" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="cyan"  aria-label="Modo claro"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Modo claro" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="DeepWiki — Registro" class="md-nav__button md-logo" aria-label="DeepWiki — Registro" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    DeepWiki — Registro
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Overview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Getting-Started.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture Overview
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Architecture Overview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Architecture-Overview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="System-Components.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    System Components
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Technology-Stack.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Technology Stack
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Request-Processing-Pipeline.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Request Processing Pipeline
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Application-Bootstrap.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Application Bootstrap
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Routing System
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Routing System
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Routing-System.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Routing System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Public-Routes.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Public Routes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Protected-Routes.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Protected Routes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="API-Endpoints.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Endpoints
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Authentication & Authorization
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Authentication & Authorization
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Authentication-%26-Authorization.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Authentication & Authorization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="User-Registration-%26-Login.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    User Registration & Login
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="JWT-Token-Management.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    JWT Token Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="verifyToken-Middleware.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    verifyToken Middleware
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Security-Measures.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security Measures
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Real-time Communication System
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Real-time Communication System
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Real-time-Communication-System.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Real-time Communication System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Socket.IO-Server-Setup.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Socket.IO Server Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="WebSocket-Authentication.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WebSocket Authentication
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Room-Management.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Room Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Message Handling
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="Message-Handling.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Message Handling
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#purpose-and-scope" class="md-nav__link">
    <span class="md-ellipsis">
      Purpose and Scope
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#event-handler-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Event Handler Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mensaje_privado-event-handler" class="md-nav__link">
    <span class="md-ellipsis">
      mensaje_privado Event Handler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="mensaje_privado Event Handler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#event-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Event Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#message-routing-logic" class="md-nav__link">
    <span class="md-ellipsis">
      Message Routing Logic
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mensaje_recibido-event-emission" class="md-nav__link">
    <span class="md-ellipsis">
      mensaje_recibido Event Emission
    </span>
  </a>
  
    <nav class="md-nav" aria-label="mensaje_recibido Event Emission">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#event-payload" class="md-nav__link">
    <span class="md-ellipsis">
      Event Payload
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emission-targets" class="md-nav__link">
    <span class="md-ellipsis">
      Emission Targets
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#message-routing-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      Message Routing Scenarios
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Message Routing Scenarios">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scenario-1-regular-user-sends-message" class="md-nav__link">
    <span class="md-ellipsis">
      Scenario 1: Regular User Sends Message
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-2-admin-sends-message" class="md-nav__link">
    <span class="md-ellipsis">
      Scenario 2: Admin Sends Message
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#message-persistence" class="md-nav__link">
    <span class="md-ellipsis">
      Message Persistence
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Message Persistence">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#database-insertion" class="md-nav__link">
    <span class="md-ellipsis">
      Database Insertion
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#table-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Table Structure
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disconnect-event-handler" class="md-nav__link">
    <span class="md-ellipsis">
      disconnect Event Handler
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http-message-retrieval-apis" class="md-nav__link">
    <span class="md-ellipsis">
      HTTP Message Retrieval APIs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HTTP Message Retrieval APIs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-apimensajes-admin-only" class="md-nav__link">
    <span class="md-ellipsis">
      GET /api/mensajes (Admin Only)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-apimensajesmios-authenticated-users" class="md-nav__link">
    <span class="md-ellipsis">
      GET /api/mensajes/mios (Authenticated Users)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-apiusuarios-conversaciones-admin-only" class="md-nav__link">
    <span class="md-ellipsis">
      GET /api/usuarios-conversaciones (Admin Only)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#complete-message-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Complete Message Flow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-points" class="md-nav__link">
    <span class="md-ellipsis">
      Integration Points
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Product-Management.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Product Management
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Support Chat System
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Support Chat System
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Support-Chat-System.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Support Chat System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="User-Chat-Interface.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    User Chat Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Admin-Chat-Interface.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Admin Chat Interface
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    PDF Generation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            PDF Generation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="PDF-Generation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PDF Generation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Puppeteer-PDF-Generation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Puppeteer PDF Generation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="PDFKit-PDF-Generation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PDFKit PDF Generation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Internationalization-%28i18n%29.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Internationalization (i18n)
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    View Layer & Templates
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            View Layer & Templates
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Template-Structure.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Template Structure
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Partial-Components.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Partial Components
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Page-Views.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Page Views
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Static-Assets-%26-Styling.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Static Assets & Styling
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
        
          
          <label class="md-nav__link" for="__nav_15" id="__nav_15_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Database Schema
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_15">
            <span class="md-nav__icon md-icon"></span>
            Database Schema
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Database-Schema.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Database Schema
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="usuarios-Table.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    usuarios Table
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="productos-Table.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    productos Table
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mensajes-Table.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    mensajes Table
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_16" >
        
          
          <label class="md-nav__link" for="__nav_16" id="__nav_16_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_16_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_16">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="API-Reference.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="HTTP-Endpoints.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HTTP Endpoints
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="WebSocket-Events.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WebSocket Events
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Deployment-%26-Configuration.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deployment & Configuration
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    README
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#purpose-and-scope" class="md-nav__link">
    <span class="md-ellipsis">
      Purpose and Scope
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#event-handler-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Event Handler Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mensaje_privado-event-handler" class="md-nav__link">
    <span class="md-ellipsis">
      mensaje_privado Event Handler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="mensaje_privado Event Handler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#event-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Event Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#message-routing-logic" class="md-nav__link">
    <span class="md-ellipsis">
      Message Routing Logic
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mensaje_recibido-event-emission" class="md-nav__link">
    <span class="md-ellipsis">
      mensaje_recibido Event Emission
    </span>
  </a>
  
    <nav class="md-nav" aria-label="mensaje_recibido Event Emission">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#event-payload" class="md-nav__link">
    <span class="md-ellipsis">
      Event Payload
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emission-targets" class="md-nav__link">
    <span class="md-ellipsis">
      Emission Targets
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#message-routing-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      Message Routing Scenarios
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Message Routing Scenarios">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scenario-1-regular-user-sends-message" class="md-nav__link">
    <span class="md-ellipsis">
      Scenario 1: Regular User Sends Message
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-2-admin-sends-message" class="md-nav__link">
    <span class="md-ellipsis">
      Scenario 2: Admin Sends Message
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#message-persistence" class="md-nav__link">
    <span class="md-ellipsis">
      Message Persistence
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Message Persistence">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#database-insertion" class="md-nav__link">
    <span class="md-ellipsis">
      Database Insertion
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#table-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Table Structure
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disconnect-event-handler" class="md-nav__link">
    <span class="md-ellipsis">
      disconnect Event Handler
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http-message-retrieval-apis" class="md-nav__link">
    <span class="md-ellipsis">
      HTTP Message Retrieval APIs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HTTP Message Retrieval APIs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-apimensajes-admin-only" class="md-nav__link">
    <span class="md-ellipsis">
      GET /api/mensajes (Admin Only)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-apimensajesmios-authenticated-users" class="md-nav__link">
    <span class="md-ellipsis">
      GET /api/mensajes/mios (Authenticated Users)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-apiusuarios-conversaciones-admin-only" class="md-nav__link">
    <span class="md-ellipsis">
      GET /api/usuarios-conversaciones (Admin Only)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#complete-message-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Complete Message Flow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-points" class="md-nav__link">
    <span class="md-ellipsis">
      Integration Points
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="message-handling">Message Handling<a class="headerlink" href="#message-handling" title="Permanent link">&para;</a></h1>
<blockquote>
<p><strong>Relevant source files</strong>
* <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js">src/router.js</a>
* <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js">src/sockets/socketHandler.js</a></p>
</blockquote>
<h2 id="purpose-and-scope">Purpose and Scope<a class="headerlink" href="#purpose-and-scope" title="Permanent link">&para;</a></h2>
<p>This document describes the WebSocket event handlers and logic for sending, routing, and persisting real-time chat messages in the support system. The message handling system processes <code>mensaje_privado</code> events from clients, routes messages to appropriate recipients through Socket.IO rooms, and persists all messages to the MySQL database. It also handles disconnect events and provides HTTP APIs for retrieving message history.</p>
<p>For information about Socket.IO server initialization, see <a href="/moichuelo/registro/7.1-socket.io-server-setup">Socket.IO Server Setup</a>. For room assignment and management, see <a href="Room-Management.html">Room Management</a>. For WebSocket authentication, see <a href="WebSocket-Authentication.html">WebSocket Authentication</a>.</p>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L1-L71">src/sockets/socketHandler.js L1-L71</a></p>
<hr />
<h2 id="event-handler-overview">Event Handler Overview<a class="headerlink" href="#event-handler-overview" title="Permanent link">&para;</a></h2>
<p>The Socket.IO server in <code>setupSocket</code> function processes two primary WebSocket events after a client connection is established:</p>
<table>
<thead>
<tr>
<th>Event Name</th>
<th>Direction</th>
<th>Purpose</th>
<th>Handler Location</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>mensaje_privado</code></td>
<td>Client → Server</td>
<td>User sends a private message</td>
<td><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L45-L63">src/sockets/socketHandler.js L45-L63</a></td>
</tr>
<tr>
<td><code>mensaje_recibido</code></td>
<td>Server → Client</td>
<td>Server delivers message to recipient(s)</td>
<td><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L48-L52">src/sockets/socketHandler.js L48-L52</a></td>
</tr>
<tr>
<td><code>disconnect</code></td>
<td>Client → Server</td>
<td>User disconnects from WebSocket</td>
<td><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L65-L67">src/sockets/socketHandler.js L65-L67</a></td>
</tr>
</tbody>
</table>
<p>The <code>mensaje_privado</code> event is received from the client, while <code>mensaje_recibido</code> is emitted by the server to deliver messages to recipients.</p>
<pre class="mermaid"><code>flowchart TD

Client1["Client (User/Admin)"]
Client2["Client (Recipient)"]
Client3["Clients (All Admins)"]
ConnectionHandler["connection event handler&lt;br&gt;line 36"]
MensajePrivado["mensaje_privado handler&lt;br&gt;line 45-63"]
Disconnect["disconnect handler&lt;br&gt;line 65-67"]
CheckRole["Check sender rol !== 'admin'&lt;br&gt;line 50"]
EmitRecipient["io.to(user:para).emit&lt;br&gt;line 48"]
EmitAdmins["io.to(admins).emit&lt;br&gt;line 51"]
DBInsert["INSERT INTO mensajes&lt;br&gt;line 55-62"]

Client1 --&gt; MensajePrivado
MensajePrivado --&gt; EmitRecipient
MensajePrivado --&gt; CheckRole
MensajePrivado --&gt; DBInsert
EmitRecipient --&gt; Client2
EmitAdmins --&gt; Client3
Client1 --&gt; Disconnect

subgraph Persistence ["Persistence"]
    DBInsert
end

subgraph subGraph1 ["Routing Logic"]
    CheckRole
    EmitRecipient
    EmitAdmins
    CheckRole --&gt; EmitAdmins
end

subgraph subGraph0 ["Socket.IO Server - socketHandler.js"]
    ConnectionHandler
    MensajePrivado
    Disconnect
end</code></pre>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L36-L68">src/sockets/socketHandler.js L36-L68</a></p>
<hr />
<h2 id="mensaje_privado-event-handler">mensaje_privado Event Handler<a class="headerlink" href="#mensaje_privado-event-handler" title="Permanent link">&para;</a></h2>
<p>The <code>mensaje_privado</code> event handler processes incoming private messages from authenticated clients. The handler is attached within the connection event listener after the user has been authenticated via JWT middleware.</p>
<h3 id="event-parameters">Event Parameters<a class="headerlink" href="#event-parameters" title="Permanent link">&para;</a></h3>
<p>The event expects a payload object with two properties:</p>
<div class="highlight"><pre><span></span><code>{ para, mensaje }
</code></pre></div>
<ul>
<li><code>para</code> (string): The username of the message recipient</li>
<li><code>mensaje</code> (string): The text content of the message</li>
</ul>
<p>The sender's username is extracted from the authenticated user context: <code>const de = user;</code> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L46-L46">src/sockets/socketHandler.js L46</a></p>
<h3 id="message-routing-logic">Message Routing Logic<a class="headerlink" href="#message-routing-logic" title="Permanent link">&para;</a></h3>
<p>The handler implements a dual-routing strategy:</p>
<ol>
<li><strong>Direct delivery to recipient</strong>: Messages are always emitted to the recipient's personal room using <code>io.to(\</code>user:${para}<code>).emit("mensaje_recibido", { de, mensaje })</code> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L48-L48">src/sockets/socketHandler.js L48</a></li>
<li><strong>Admin broadcast</strong>: If the sender is NOT an admin (<code>rol !== "admin"</code>), the message is also broadcast to all admins in the <code>"admins"</code> room <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L50-L52">src/sockets/socketHandler.js L50-L52</a>  This allows administrators to monitor all user conversations.</li>
</ol>
<pre class="mermaid"><code>flowchart TD

Event["mensaje_privado event received&lt;br&gt;{para, mensaje}"]
ExtractSender["Extract sender: de = user&lt;br&gt;line 46"]
EmitRecipient["Emit to recipient room&lt;br&gt;io.to(user:para).emit(mensaje_recibido)&lt;br&gt;line 48"]
CheckRole["Is sender role&lt;br&gt;!== 'admin'?&lt;br&gt;line 50"]
EmitAdmins["Broadcast to admins room&lt;br&gt;io.to(admins).emit(mensaje_recibido)&lt;br&gt;line 51"]
Persist["Insert into mensajes table&lt;br&gt;line 55-62"]

Event --&gt; ExtractSender
ExtractSender --&gt; EmitRecipient
EmitRecipient --&gt; CheckRole
CheckRole --&gt; EmitAdmins
CheckRole --&gt; Persist
EmitAdmins --&gt; Persist</code></pre>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L45-L63">src/sockets/socketHandler.js L45-L63</a></p>
<hr />
<h2 id="mensaje_recibido-event-emission">mensaje_recibido Event Emission<a class="headerlink" href="#mensaje_recibido-event-emission" title="Permanent link">&para;</a></h2>
<p>The <code>mensaje_recibido</code> event is emitted by the server to deliver messages to connected clients. This event is never sent by clients; it is strictly a server-to-client communication.</p>
<h3 id="event-payload">Event Payload<a class="headerlink" href="#event-payload" title="Permanent link">&para;</a></h3>
<p>The emitted event carries:</p>
<div class="highlight"><pre><span></span><code>{ de, mensaje }
</code></pre></div>
<ul>
<li><code>de</code> (string): The username of the message sender</li>
<li><code>mensaje</code> (string): The message text content</li>
</ul>
<h3 id="emission-targets">Emission Targets<a class="headerlink" href="#emission-targets" title="Permanent link">&para;</a></h3>
<p>The event is emitted to Socket.IO rooms using <code>io.to(roomName).emit()</code>:</p>
<ul>
<li><strong>Recipient's personal room</strong>: <code>io.to(\</code>user:${para}<code>)</code> - Delivers the message to the intended recipient <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L48-L48">src/sockets/socketHandler.js L48</a></li>
<li><strong>Admins room</strong> (conditional): <code>io.to("admins")</code> - Broadcasts user messages to all connected administrators <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L51-L51">src/sockets/socketHandler.js L51</a></li>
</ul>
<p>The room-based emission ensures messages are only delivered to the intended recipients without iterating through all connected sockets.</p>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L48-L52">src/sockets/socketHandler.js L48-L52</a></p>
<hr />
<h2 id="message-routing-scenarios">Message Routing Scenarios<a class="headerlink" href="#message-routing-scenarios" title="Permanent link">&para;</a></h2>
<p>The routing behavior differs based on sender role:</p>
<h3 id="scenario-1-regular-user-sends-message">Scenario 1: Regular User Sends Message<a class="headerlink" href="#scenario-1-regular-user-sends-message" title="Permanent link">&para;</a></h3>
<p>When a user with <code>rol !== "admin"</code> sends a message:</p>
<ol>
<li>Message is emitted to the recipient's personal room</li>
<li>Message is broadcast to all administrators in the <code>"admins"</code> room</li>
<li>Message is persisted to database</li>
</ol>
<p>This allows administrators to see all user conversations in real-time for support monitoring.</p>
<h3 id="scenario-2-admin-sends-message">Scenario 2: Admin Sends Message<a class="headerlink" href="#scenario-2-admin-sends-message" title="Permanent link">&para;</a></h3>
<p>When an administrator sends a message:</p>
<ol>
<li>Message is emitted ONLY to the recipient's personal room</li>
<li>Message is NOT broadcast to the <code>"admins"</code> room (preventing echo)</li>
<li>Message is persisted to database</li>
</ol>
<p>The condition <code>if (rol !== "admin")</code> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L50-L50">src/sockets/socketHandler.js L50</a></p>
<p>prevents admin messages from being broadcast to the admin room, avoiding duplicate notifications.</p>
<pre class="mermaid"><code>flowchart TD

A1["User: admin1&lt;br&gt;rol=admin"]
A2["User: alice&lt;br&gt;recipient"]
A3["Admins Room&lt;br&gt;(NOT notified)"]
U1["User: alice&lt;br&gt;rol=user"]
U2["User: bob&lt;br&gt;recipient"]
U3["Admins Room&lt;br&gt;(all admins)"]

subgraph subGraph1 ["Admin Sends Message"]
    A1
    A2
    A3
    A1 --&gt; A2
    A1 --&gt; A3
end

subgraph subGraph0 ["User Sends Message"]
    U1
    U2
    U3
    U1 --&gt; U2
    U1 --&gt; U3
end</code></pre>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L45-L52">src/sockets/socketHandler.js L45-L52</a></p>
<hr />
<h2 id="message-persistence">Message Persistence<a class="headerlink" href="#message-persistence" title="Permanent link">&para;</a></h2>
<p>All messages, regardless of routing, are persisted to the MySQL <code>mensajes</code> table to maintain a complete conversation history.</p>
<h3 id="database-insertion">Database Insertion<a class="headerlink" href="#database-insertion" title="Permanent link">&para;</a></h3>
<p>The insertion uses a parameterized SQL query to prevent injection attacks:</p>
<div class="highlight"><pre><span></span><code><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">mensajes</span><span class="w"> </span><span class="p">(</span><span class="n">de_usuario</span><span class="p">,</span><span class="w"> </span><span class="n">para_usuario</span><span class="p">,</span><span class="w"> </span><span class="n">mensaje</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
</code></pre></div>
<p>Parameters: <code>[de, para, mensaje]</code> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L55-L56">src/sockets/socketHandler.js L55-L56</a></p>
<p>The database operation is asynchronous and logs success or failure:</p>
<ul>
<li>Success: <code>console.log("💾 Mensaje guardado:", \</code>${de} ➡️ ${para}<code>)</code>  <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L60-L60">src/sockets/socketHandler.js L60</a></li>
<li>Error: <code>console.error("❌ Error al guardar mensaje:", err)</code> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L58-L58">src/sockets/socketHandler.js L58</a></li>
</ul>
<h3 id="table-structure">Table Structure<a class="headerlink" href="#table-structure" title="Permanent link">&para;</a></h3>
<p>The <code>mensajes</code> table contains:</p>
<ul>
<li><code>de_usuario</code>: Foreign key to <code>usuarios.usuario</code> (sender)</li>
<li><code>para_usuario</code>: Foreign key to <code>usuarios.usuario</code> (recipient)</li>
<li><code>mensaje</code>: TEXT field for message content</li>
<li><code>fecha</code>: DATETIME field (auto-populated by database default)</li>
</ul>
<p>For complete database schema details, see <a href="mensajes-Table.html">mensajes Table</a>.</p>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L55-L62">src/sockets/socketHandler.js L55-L62</a></p>
<hr />
<h2 id="disconnect-event-handler">disconnect Event Handler<a class="headerlink" href="#disconnect-event-handler" title="Permanent link">&para;</a></h2>
<p>The <code>disconnect</code> event is automatically fired by Socket.IO when a client WebSocket connection is closed (browser tab closed, network interruption, explicit disconnect).</p>
<p>The handler simply logs the disconnection event:</p>
<div class="highlight"><pre><span></span><code><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;disconnect&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`🔴 Usuario desconectado: </span><span class="si">${</span><span class="nx">user</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L65-L67">src/sockets/socketHandler.js L65-L67</a></p>
<p>When a user disconnects:</p>
<ol>
<li>Socket.IO automatically removes them from all rooms they joined</li>
<li>The socket instance is destroyed</li>
<li>No database operations are performed</li>
<li>No cleanup of messages is required (messages persist in database)</li>
</ol>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L65-L67">src/sockets/socketHandler.js L65-L67</a></p>
<hr />
<h2 id="http-message-retrieval-apis">HTTP Message Retrieval APIs<a class="headerlink" href="#http-message-retrieval-apis" title="Permanent link">&para;</a></h2>
<p>While real-time messages are delivered via WebSocket events, the system provides HTTP REST endpoints for retrieving historical messages. These endpoints are used by clients when first loading the chat interface or when reconnecting after a disconnection.</p>
<h3 id="get-apimensajes-admin-only">GET /api/mensajes (Admin Only)<a class="headerlink" href="#get-apimensajes-admin-only" title="Permanent link">&para;</a></h3>
<p>Retrieves all messages for a specific user's conversation. Requires admin authentication via <code>verifyAdmin</code> middleware.</p>
<p><strong>Query Parameter:</strong></p>
<ul>
<li><code>con</code> (required): Username to retrieve messages for</li>
</ul>
<p><strong>SQL Query:</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">de_usuario</span><span class="p">,</span><span class="w"> </span><span class="n">para_usuario</span><span class="p">,</span><span class="w"> </span><span class="n">mensaje</span><span class="p">,</span><span class="w"> </span><span class="n">fecha</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">mensajes</span>
<span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">de_usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">para_usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">fecha</span><span class="w"> </span><span class="k">ASC</span>
</code></pre></div>
<p><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L236-L242">src/router.js L236-L242</a></p>
<p>The query retrieves messages where the specified user is either the sender OR recipient, ordered chronologically.</p>
<p><strong>Response:</strong> JSON array of message objects
<strong>Authorization:</strong> Admin role required <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L229-L229">src/router.js L229</a></p>
<h3 id="get-apimensajesmios-authenticated-users">GET /api/mensajes/mios (Authenticated Users)<a class="headerlink" href="#get-apimensajesmios-authenticated-users" title="Permanent link">&para;</a></h3>
<p>Retrieves all messages for the currently authenticated user. Requires token authentication via <code>verifyToken</code> middleware.</p>
<p>The username is extracted from the JWT payload: <code>const usuario = req.user.user;</code> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L257-L257">src/router.js L257</a></p>
<p><strong>SQL Query:</strong>
Same as admin endpoint, but filters by the authenticated user's username <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L263-L269">src/router.js L263-L269</a></p>
<p><strong>Response:</strong> JSON array of message objects
<strong>Authorization:</strong> Any authenticated user <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L256-L256">src/router.js L256</a></p>
<h3 id="get-apiusuarios-conversaciones-admin-only">GET /api/usuarios-conversaciones (Admin Only)<a class="headerlink" href="#get-apiusuarios-conversaciones-admin-only" title="Permanent link">&para;</a></h3>
<p>Retrieves a list of all users who have active conversations with administrators. Used by the admin interface to populate the user list sidebar.</p>
<p><strong>SQL Query:</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">usuario</span>
<span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">de_usuario</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">mensajes</span>
<span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="n">para_usuario</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">usuarios</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">rol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>

<span class="w">  </span><span class="k">UNION</span>

<span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">para_usuario</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">mensajes</span>
<span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="n">de_usuario</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">usuarios</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">rol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">conversaciones</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">usuarios</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">rol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
</code></pre></div>
<p><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L292-L304">src/router.js L292-L304</a></p>
<p>The query uses UNION to find users who either:</p>
<ol>
<li>Sent messages TO admins, OR</li>
<li>Received messages FROM admins</li>
</ol>
<p>It excludes admin usernames from the results.</p>
<p><strong>Response:</strong> JSON array of usernames (strings) <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L312-L313">src/router.js L312-L313</a></p>
<p><strong>Authorization:</strong> Admin role required <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L283-L283">src/router.js L283</a></p>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L229-L315">src/router.js L229-L315</a></p>
<hr />
<h2 id="complete-message-flow">Complete Message Flow<a class="headerlink" href="#complete-message-flow" title="Permanent link">&para;</a></h2>
<p>The following diagram illustrates the complete lifecycle of a message from client initiation through delivery and persistence:</p>
<pre class="mermaid"><code>sequenceDiagram
  participant Client (Sender)
  participant Socket.IO Server
  participant Room: user:recipient
  participant Room: admins
  participant MySQL mensajes table

  note over Client (Sender): User clicks send in chat UI
  Client (Sender)-&gt;&gt;Socket.IO Server: emit("mensaje_privado", {para, mensaje})
  note over Socket.IO Server: Handler at line 45
  Socket.IO Server-&gt;&gt;Socket.IO Server: Extract de = user (line 46)
  Socket.IO Server-&gt;&gt;Room: user:recipient: emit("mensaje_recibido", {de, mensaje})
  note over Room: user:recipient: Recipient receives message
  loop [Sender is NOT admin]
    Socket.IO Server-&gt;&gt;Room: admins: emit("mensaje_recibido", {de, mensaje})
    note over Room: admins: All admins receive notification
    Socket.IO Server-&gt;&gt;MySQL mensajes table: INSERT INTO mensajes
    MySQL mensajes table--&gt;&gt;Socket.IO Server: (de_usuario, para_usuario, mensaje)
    note over Socket.IO Server: Log: 💾 Mensaje guardado
    note over Socket.IO Server: Log: ❌ Error al guardar mensaje
  end</code></pre>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L45-L63">src/sockets/socketHandler.js L45-L63</a></p>
<hr />
<h2 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h2>
<p>The message handling system includes basic error handling:</p>
<ol>
<li><strong>Database errors</strong>: Caught in the callback of <code>db.query()</code> and logged to console <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L57-L61">src/sockets/socketHandler.js L57-L61</a>  The message is still delivered to recipients even if persistence fails.</li>
<li><strong>Authentication errors</strong>: Handled by the Socket.IO middleware before messages can be sent (see <a href="WebSocket-Authentication.html">WebSocket Authentication</a>)</li>
<li><strong>Missing parameters</strong>: No explicit validation exists in the handler. If <code>para</code> or <code>mensaje</code> are undefined, the emission will still occur but may fail at the client level.</li>
<li><strong>Room not found</strong>: Socket.IO silently ignores emissions to rooms with no members. Messages to offline users are persisted but not delivered until reconnection.</li>
</ol>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L45-L63">src/sockets/socketHandler.js L45-L63</a></p>
<hr />
<h2 id="integration-points">Integration Points<a class="headerlink" href="#integration-points" title="Permanent link">&para;</a></h2>
<p>The message handling system integrates with:</p>
<table>
<thead>
<tr>
<th>Component</th>
<th>Integration Point</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>JWT Authentication</td>
<td><code>socket.request.user</code> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L37-L37">src/sockets/socketHandler.js L37</a></td>
<td>Extracts sender identity</td>
</tr>
<tr>
<td>Room Management</td>
<td><code>socket.join()</code> called in connection handler <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L42-L43">src/sockets/socketHandler.js L42-L43</a></td>
<td>Establishes room membership</td>
</tr>
<tr>
<td>MySQL Database</td>
<td><code>db.query()</code> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L56-L56">src/sockets/socketHandler.js L56</a></td>
<td>Persists message history</td>
</tr>
<tr>
<td>HTTP API</td>
<td><code>/api/mensajes</code> endpoints <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L229-L280">src/router.js L229-L280</a></td>
<td>Retrieves historical messages</td>
</tr>
<tr>
<td>Client UI</td>
<td><code>views/soporte.ejs</code></td>
<td>Emits <code>mensaje_privado</code>, listens for <code>mensaje_recibido</code></td>
</tr>
</tbody>
</table>
<p>For Socket.IO room assignments, see <a href="Room-Management.html">Room Management</a>. For database table structure, see <a href="mensajes-Table.html">mensajes Table</a>. For client-side implementation, see <a href="Support-Chat-System.html">Support Chat System</a>.</p>
<p><strong>Sources:</strong> <a href="https://github.com/moichuelo/registro/blob/544abbcc/src/sockets/socketHandler.js#L1-L71">src/sockets/socketHandler.js L1-L71</a></p>
<p><a href="https://github.com/moichuelo/registro/blob/544abbcc/src/router.js#L229-L315">src/router.js L229-L315</a></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": ".", "features": ["content.code.copy"], "search": "assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
      
        <script src="javascripts/mermaid-init.js"></script>
      
    
  </body>
</html>